<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="k9WS1EOfLnS9AypLcsMakrYfXwMf0dUn-t3o0ISNMy4"><meta name="baidu-site-verification" content="GTIjN6Pg5u"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"blog.d77.xyz","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script><meta name="description" content="偶然的机会，发现 HTTP 代理和 HTTPS 代理这两个词，没接触过 HTTPS 代理，所以动手查了查，记录一下。"><meta property="og:type" content="article"><meta property="og:title" content="Nginx-Caddy之HTTP-HTTPS代理区别"><meta property="og:url" content="https://blog.d77.xyz/archives/6fb5f2d2.html"><meta property="og:site_name" content="LLLibra146&#39;s blog"><meta property="og:description" content="偶然的机会，发现 HTTP 代理和 HTTPS 代理这两个词，没接触过 HTTPS 代理，所以动手查了查，记录一下。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200705212146471.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200705213356053.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706161445908.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706161547643.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706162018564.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706162301165.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706162851934.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706162949832.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706163559772.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706164848239.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706165126094.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706193608158.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706193714941.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706193936303.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706194514479.png"><meta property="og:image" content="https://blogimg.d77.xyz/image-20200706195015443.png"><meta property="og:image" content="https://blogimg.d77.xyz/qrcode_for_gh_10d7d04417bb_430.jpg"><meta property="article:published_time" content="2020-07-04T10:58:36.000Z"><meta property="article:modified_time" content="2025-01-23T15:06:23.638Z"><meta property="article:author" content="LLLibra146"><meta property="article:tag" content="HTTP"><meta property="article:tag" content="HTTPS"><meta property="article:tag" content="Caddy"><meta property="article:tag" content="Nginx"><meta property="article:tag" content="代理"><meta property="article:tag" content="SSL"><meta property="article:tag" content="Wireshark"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blogimg.d77.xyz/image-20200705212146471.png"><link rel="canonical" href="https://blog.d77.xyz/archives/6fb5f2d2.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.d77.xyz/archives/6fb5f2d2.html","path":"/archives/6fb5f2d2.html","title":"Nginx-Caddy之HTTP-HTTPS代理区别"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Nginx-Caddy之HTTP-HTTPS代理区别 | LLLibra146's blog</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-GR9YXDQ843"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-GR9YXDQ843","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?c76c7b91ebcbf02b7fc1f26bf23121ff"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">LLLibra146's blog</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Personal note</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">213</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">32</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">94</span></a></li></ul></nav></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP-%E4%BB%A3%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">HTTP 代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTPS-%E4%BB%A3%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">HTTPS 代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95HTTP%E4%BB%A3%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">测试HTTP代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95HTTPS%E4%BB%A3%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">测试HTTPS代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nginx-x2F-Caddy%E6%90%AD%E5%BB%BAHTTPS%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">5.</span> <span class="nav-text">Nginx&#x2F;Caddy搭建HTTPS代理服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%AF%86SSL"><span class="nav-number">6.</span> <span class="nav-text">解密SSL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="LLLibra146" src="https://blogimg.d77.xyz/logo.png"><p class="site-author-name" itemprop="name">LLLibra146</p><div class="site-description" itemprop="description">小时侯，幸福是很简单的事；长大了，简单是很幸福的事！</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">94</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">32</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">213</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/libra146" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;libra146" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1462326016@qq.com" title="E-Mail → mailto:1462326016@qq.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.d77.xyz/archives/6fb5f2d2.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://blogimg.d77.xyz/logo.png"><meta itemprop="name" content="LLLibra146"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LLLibra146's blog"><meta itemprop="description" content="小时侯，幸福是很简单的事；长大了，简单是很幸福的事！"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Nginx-Caddy之HTTP-HTTPS代理区别 | LLLibra146's blog"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Nginx-Caddy之HTTP-HTTPS代理区别</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-07-04 18:58:36 18:58:36" itemprop="dateCreated datePublished" datetime="2020-07-04T18:58:36+08:00">2020-07-04 18:58:36</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-01-23 23:06:23 23:06:23" itemprop="dateModified" datetime="2025-01-23T23:06:23+08:00">2025-01-23 23:06:23</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Web/" itemprop="url" rel="index"><span itemprop="name">Web</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>偶然的机会，发现 HTTP 代理和 HTTPS 代理这两个词，没接触过 HTTPS 代理，所以动手查了查，记录一下。</p><span id="more"></span><h4 id="HTTP-代理"><a href="#HTTP-代理" class="headerlink" title="HTTP 代理"></a>HTTP 代理</h4><p>普通的 HTTP 代理是将浏览器发出的 HTTP 请求直接发送到代理服务器，然后代理服务器将 HTTP 请求进行解析，添加对应的源 IP（这里不考虑高匿代理），根据代理服务器的不同会对请求头进行不同的修改，然后将修改后的请求头和请求体一起发送到对应的服务器，然后等待服务器回复，将服务器返回的 HTTP 请求转发给客户端，完成代理任务。在这种情况下，HTTP 请求存在数据被代理服务器修改的情况，如果连接的是一个恶意的代理服务器，那么就可能存在数据泄露，隐私泄露等情况。使用 HTTPS 协议来访问对应服务器就可以避免这种问题。</p><p>为了确保数据的安全，HTTPS 请求的域名和端口都是加密的，所以代理服务器无法进行解析，也就无法修改对应的请求体，无法进行正常的 HTTP 转发任务。为了解决这个问题，就需要用到 CONNECT 方法。</p><ol><li>当使用设置了代理服务器的浏览器发送 HTTPS 请求时，浏览器会先发送 CONNECT 包（未加密的）到代理服务器。</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CONNECT</span> <span class="string">www.microsoft.com:443</span> <span class="meta">HTTP/1.0</span></span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>www.microsoft.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">DNT</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Keep-Alive</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br></pre></td></tr></table></figure><ol start="2"><li>代理服务器根据包中的内容，会在对应端口上和目标站点就建立一个 TCP 连接，建立成功后，会给客户端返回一个 HTTP 200 的状态码告知已连接成功。</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.0</span> <span class="number">200</span> Connection Established</span><br><span class="line"><span class="attribute">FiddlerGateway</span><span class="punctuation">: </span>Direct</span><br><span class="line"><span class="attribute">StartTime</span><span class="punctuation">: </span>11:56:22.008</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">EndTime</span><span class="punctuation">: </span>11:56:22.538</span><br><span class="line"><span class="attribute">ClientToServerBytes</span><span class="punctuation">: </span>1416</span><br><span class="line"><span class="attribute">ServerToClientBytes</span><span class="punctuation">: </span>1358</span><br></pre></td></tr></table></figure><ol start="3"><li>之后浏览器会和目标网站进行正常的 HTTPS 握手请求，建立 TLS 隧道，并交换加密数据，代理服务器只会进行数据的转发，不会读取数据包中的内容，因为数据是加密的，所以想读取也是读取不了的。通过下图的抓包可以看出来，在进行了 TCP 三次握手之后，浏览器发送了 CONNECT 请求到代理服务器，之后代理服务器返回了 HTTP 200 的状态码告知已连接成功，然后浏览器开始和目标网站进行正常的 TLS 握手过程。</li></ol><p><img data-src="https://blogimg.d77.xyz/image-20200705212146471.png"></p><p>通过以上过程可以看到，通过代理服务器可以使 HTTP 和 HTTPS 请求都正常进行代理转发，而不需要客户端进行任何其他操作。</p><p>但是这里边有个问题在于 CONNECT 请求是明文的，如果在客户端和代理服务器之间进行中间人攻击的话，是有可能实现的。而且明文的请求可能会泄露客户端使用者的隐私数据，尤其是访问 HTTP 网站的情况下，还可能造成 Cookie 等认证信息的泄露，非常危险。</p><h4 id="HTTPS-代理"><a href="#HTTPS-代理" class="headerlink" title="HTTPS 代理"></a>HTTPS 代理</h4><p>HTTPS 代理是指 HTTP 代理支持 CONNECT 方法还是基于 SSL 的 HTTP 代理？我希望是后者， 但是一般情况下，我们所使用到的所看到的都是前者。</p><p>市面上的免费 HTTP&#x2F;HTTPS 代理都只是 HTTP 代理支持 CONNECT 方法，并没有使用 SSL 隧道。也就是说基本上所有的代理服务器上标的 HTTPS 的意思仅仅是支持 HTTPS 流量，并不是真正的 HTTPS 代理。</p><p><img data-src="https://blogimg.d77.xyz/image-20200705213356053.png"></p><p>基于 SSL 的 HTTP 代理解释起来其实很简单，跟 HTTPS 是一样的，这里的 HTTPS 指的是 HTTPS 协议，HTTPS 协议就是跑在 SSL 隧道上的 HTTP 代理，所以基于 SSL 隧道的 HTTP 代理就叫它 HTTPS 代理吧。有关 HTTPS 代理的具体说明或者说是官方定义，我只找到了类似的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3794376/can-browsers-connect-to-a-proxy-over-ssl-tls">问题</a>，没有找到官方的解释或是说明，有了解的小伙伴欢迎联系我。</p><p>通过<a target="_blank" rel="noopener" href="http://www.chromium.org/developers/design-documents/secure-web-proxy">这个</a>链接可以得知 Chrome 是支持这种代理方案的，一般情况下 Chrome 代理都是通过 Chrome 拓展的方式进行设置的，如果没有拓展的话 Chrome 默认使用的是系统代理，系统代理据我所知是只支持 HTTP 代理的，所以我们这里使用 SwitchyOmega 这个拓展来设置 HTTPS 代理，然后测试 HTTPS 代理。</p><h4 id="测试HTTP代理"><a href="#测试HTTP代理" class="headerlink" title="测试HTTP代理"></a>测试HTTP代理</h4><p>由于 HTTP 代理比较简单并且在 HTTP 代理中已经抓过包了，所以这里就不进行测试了。</p><h4 id="测试HTTPS代理"><a href="#测试HTTPS代理" class="headerlink" title="测试HTTPS代理"></a>测试HTTPS代理</h4><p>我们使用 SwitchyOmega 设置好 HTTPS 代理，由于一般的代理调试起来不是很方便，所以我们这里使用自己写脚本的方式来接收浏览器发出的流量，并且打印出来，还可以返回我们自定义的数据。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706161445908.png"></p><p>由于浏览器和服务器进行搭建 TLS 隧道需要证书，所以我们这里使用 ssl 这个库，加载我之前申请好的证书，当然了，域名也要提前准备好，然后将收到的数据打印出来，就可以看到浏览器通过 SSL 隧道发送的数据是什么了。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706161547643.png"></p><p>然后在服务器上将脚本跑起来，使用浏览器访问一个 HTTP 网站看看，浏览器端接收到了我们脚本所返回的数据。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706162018564.png"></p><p>服务器上的脚本也接收到了浏览器所发送的 HTTP 请求。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706162301165.png"></p><p>然后访问一个 HTTPS 请求试一下，由于我们使用脚本返回的数据不是浏览器预期接收到的数据，所以浏览器会报错，告诉我们网址无法连接。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706162851934.png"></p><p>在服务器上，我们可以看到浏览器发送给我们的 CONNECT 请求，这里由于浏览器默认会重试几次，所以有好几个请求。如果我们使用脚本回复一个正确的 200 请求的话，那么浏览器应该会继续发送后续的 TSL 握手包，进行正常的 HTTPS 握手。由于会增加脚本的复杂度，这里就不继续往下测试了。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706162949832.png"></p><p>同时我们使用 Wireshark 抓包也可以发现，在进行完 TCP 三次握手（红框）之后，继而进行了 TLS 握手请求，看不到 CONNECT 请求，所以我们基本可以确定，HTTPS 代理跑在 TLS 隧道之上的 HTTP 代理。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706163559772.png"></p><h4 id="Nginx-x2F-Caddy搭建HTTPS代理服务器"><a href="#Nginx-x2F-Caddy搭建HTTPS代理服务器" class="headerlink" title="Nginx&#x2F;Caddy搭建HTTPS代理服务器"></a>Nginx&#x2F;Caddy搭建HTTPS代理服务器</h4><p>测试完成了， 但是没有形成一个完成的闭环，由于 HTTPS 抓包的复杂性，我们通过测试脚本只是单向测试了 HTTPS 流量，没有正常访问到 HTTPS 的网站，所以我们这里使用 <a target="_blank" rel="noopener" href="https://caddyserver.com/">Caddy</a> 来搭建一个测试服务器来验证 HTTPS 代理是否可以正常工作。</p><p>为什么不使用 Nginx 呢，因为 Nginx 默认不支持转发 CONNECT 请求，需要重新编译添加补丁才可以，这里为了方便不使用 Nginx 进行测试。</p><p>下载安装 Caddy 这里就不提了， 主要提示下使用 Caddy 进行 HTTPS 正向代理时需要添加 forwardproxy 插件，在下载 Caddy 时记得勾选插件。</p><p>关于配置文件的配置方法，可以见<a target="_blank" rel="noopener" href="https://caddyserver.com/docs/">文档</a>。我使用的 Caddy 的配置文件如下：</p><p><img data-src="https://blogimg.d77.xyz/image-20200706164848239.png"></p><p>然后使用浏览器访问一个 HTTPS 网站，可以发现可以正常访问了，再次使用 Wireshark 抓包的结果发现和上一步测试 HTTPS 代理的结果是一样的。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706165126094.png"></p><h4 id="解密SSL"><a href="#解密SSL" class="headerlink" title="解密SSL"></a>解密SSL</h4><p>这里使用 Caddy 我们看到了可以正常访问 HTTPS 网站，但是问题来了，我们怎么验证 TLS 隧道中跑的流量是 HTTP 代理的流量呢？虽然之前已经使用我们自己写的脚本测试过，但是我们换了 Caddy 当作代理服务器，所以为了严谨性我们还是证实下。我们使用 SSLKEYLOGFILE 这个文件来解密浏览器发出的 HTTPS 流量。SSLKEYLOGFILE 的话 Chrome 和 火狐我记得应该都是支持的。</p><p>配置好了 SSLKEYLOGFILE 的话 Chrome 和 火狐会自动将 TLS 隧道的解密密钥写入到定义好的文件中。我们可以在抓包软件中自动化解密请求。</p><p>首先将 SSLKEYLOGFILE 配置到环境变量中</p><p><img data-src="https://blogimg.d77.xyz/image-20200706193608158.png"></p><p>然后使用浏览器访问一次 HTTPS 网站，打开我们指向的 log 文件，我们可以看到里边已经记录了很多的密钥，使用这些密钥就可以解密对应的 HTTPS 流量了。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706193714941.png"></p><p>我们使用 Wireshark 来完成这个任务。在首选项的 Protocols 中找到 TLS 选项，然后按照图中方法设置将路径指向到刚才保存的 log 文件中。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706193936303.png"></p><p>之后重启 Wireshark，开启抓包，使用浏览器再次访问 HTTPS 网站，然后看 Wireshark，可以发现在 TCP 三次握手之后是 TLS 握手，TLS 握手结束后是明文的 HTTP2 的请求，不再是加密的数据。进一步往下看的话，可以发现是使用 HTTP2 协议发送的 CONNECT 请求，确认是使用了 HTTP 代理，虽然是 HTTP2 的 HTTP 代理。</p><p><img data-src="https://blogimg.d77.xyz/image-20200706194514479.png"></p><p><img data-src="https://blogimg.d77.xyz/image-20200706195015443.png"></p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>通过对比和验证，可以了解到 HTTP 代理和 HTTPS 代理的区别，使用代理服务器和 CONNECT 方法，实现了转发 HTTP 流量和 HTTPS 流量。对于如何对猜想进行验证， 我们在这里首先使用自定义脚本的方式直接接收浏览器发出的二进制流量， 可以明显看出浏览器发出的数据的确是 HTTP 代理的流量，然后使用 Web 服务器的方式验证了 HTTP 代理的流量的确是跑在 TLS 隧道里，最后使用 Wireshark 解密 TLS 流量的方式确定了浏览器和 Web 服务器（Caddy）的确是通过 HTTP 代理的方式进行通信的，所以我们最终确定 HTTPS 代理就是跑在 TLS 隧道上的 HTTP 代理。</p><p>当然，解密 TLS 流量的方式不止这一个，还可以使用中间人的方式来解密，自签证书安装到系统中，然后使用两层代理的方式来转发流量到代理服务器，也就是说：浏览器流量 -&gt; 本地抓包软件（安装好了证书）-&gt; 流量转发软件 -&gt; 代理服务器。这样的话实施起来会有点难度，同时也不是很好理解， 可能对我们的验证造成干扰，所以这里并没有使用这种办法。</p><p>最后解释下 TLS （HTTPS）是否真的安全？答案是否定的，从上面的中间人解密就可以看得出来，有不止一种可以解密 TLS 隧道中的数据，所以答案应该是相对安全，还是要日常防范中间人攻击。</p><p>以上就是本篇博客的全部内容。</p><blockquote><p>注：以上分析流程及结果仅限用于学习和研究目的；不得将上述内容用于商业或者非法用途，否则，一切后果与作者无关。</p></blockquote><p>参考链接；</p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3794376/can-browsers-connect-to-a-proxy-over-ssl-tls">https://stackoverflow.com/questions/3794376/can-browsers-connect-to-a-proxy-over-ssl-tls</a></p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/45874515/what-is-https-proxy">https://stackoverflow.com/questions/45874515/what-is-https-proxy</a></p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6594604/connect-request-to-a-forward-http-proxy-over-an-ssl-connection">https://stackoverflow.com/questions/6594604/connect-request-to-a-forward-http-proxy-over-an-ssl-connection</a></p><p><a target="_blank" rel="noopener" href="https://juejin.im/post/5d317299f265da1bc14b6342">https://juejin.im/post/5d317299f265da1bc14b6342</a></p><p><a target="_blank" rel="noopener" href="https://caddyserver.com/">https://caddyserver.com/</a></p><p><a target="_blank" rel="noopener" href="https://caddyserver.com/docs/">https://caddyserver.com/docs/</a></p><blockquote><p>本文章首发于个人博客 <strong>LLLibra146’s blog</strong><br><strong>本文作者</strong>：LLLibra146<br>更多文章请关注：<img data-src="https://blogimg.d77.xyz/qrcode_for_gh_10d7d04417bb_430.jpg" alt="qrcode"><br><strong>版权声明</strong>：本博客所有文章除特别声明外，均采用 © <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">BY-NC-ND</a> 许可协议。非商用转载请注明出处！严禁商业转载！<br><strong>本文链接</strong>：<br><a href="https://blog.d77.xyz/archives/6fb5f2d2.html">https://blog.d77.xyz/archives/6fb5f2d2.html</a></p></blockquote></div><footer class="post-footer"><div class="post-tags"><a href="/tags/HTTP/" rel="tag"><i class="fa fa-tag"></i> HTTP</a> <a href="/tags/HTTPS/" rel="tag"><i class="fa fa-tag"></i> HTTPS</a> <a href="/tags/Caddy/" rel="tag"><i class="fa fa-tag"></i> Caddy</a> <a href="/tags/Nginx/" rel="tag"><i class="fa fa-tag"></i> Nginx</a> <a href="/tags/%E4%BB%A3%E7%90%86/" rel="tag"><i class="fa fa-tag"></i> 代理</a> <a href="/tags/SSL/" rel="tag"><i class="fa fa-tag"></i> SSL</a> <a href="/tags/Wireshark/" rel="tag"><i class="fa fa-tag"></i> Wireshark</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/f036ccea.html" rel="prev" title="通过Cloudflare设置301重定向"><i class="fa fa-chevron-left"></i> 通过Cloudflare设置301重定向</a></div><div class="post-nav-item"><a href="/archives/87a89514.html" rel="next" title="SQLAlchemy多线程报错">SQLAlchemy多线程报错 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments giscus-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">津ICP备15003765号</a></div><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">LLLibra146</span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动</div></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><a href="https://github.com/libra146" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="/js/third-party/fancybox.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://blog.d77.xyz/archives/6fb5f2d2.html"}</script><script src="/js/third-party/quicklink.js"></script><script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"libra146/libra146.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkxOTI0ODgxODA","category":"Announcements","category_id":"DIC_kwDOC3ki9M4CYegl","mapping":"pathname","reactions_enabled":1,"emit_metadata":0,"theme":"light","lang":"zh-CN","input_position":"bottom","loading":"lazy"}</script><script>document.addEventListener("page:loaded",()=>{CONFIG.page.comments&&NexT.utils.loadComments(".giscus-container").then(()=>NexT.utils.getScript("https://giscus.app/client.js",{attributes:{async:!0,crossOrigin:"anonymous","data-repo":CONFIG.giscus.repo,"data-repo-id":CONFIG.giscus.repo_id,"data-category":CONFIG.giscus.category,"data-category-id":CONFIG.giscus.category_id,"data-mapping":CONFIG.giscus.mapping,"data-reactions-enabled":CONFIG.giscus.reactions_enabled,"data-emit-metadata":CONFIG.giscus.emit_metadata,"data-theme":CONFIG.giscus.theme,"data-lang":CONFIG.giscus.lang,"data-input-position":CONFIG.giscus.input_position,"data-loading":CONFIG.giscus.loading},parentNode:document.querySelector(".giscus-container")}))})</script></body></html>